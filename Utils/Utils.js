"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.AsyncGroup = exports.SaveCookies = exports.ParseCookie = exports.CreateRecordInstance = exports.Guid = exports.nameof = exports.ShiyiDebug = exports.Debug = exports.KeyValuePair = void 0;
var Storage_Config_1 = require("../Config/StorageConfig/Storage.Config");
var Utils_Config_1 = require("../Config/UtilsConfig/Utils.Config");
var KeyValuePair = (function () {
    function KeyValuePair(_key, _value) {
        this.Key = _key;
        this.Value = _value;
    }
    return KeyValuePair;
}());
exports.KeyValuePair = KeyValuePair;
function Debug(level) {
    if (Utils_Config_1.DebugLevel == 0) {
        return function () {
            var _ = [];
            for (var _i = 0; _i < arguments.length; _i++) {
                _[_i] = arguments[_i];
            }
        };
    }
    else if (level <= Utils_Config_1.DebugLevel) {
        return console.log;
    }
    return function () {
        var _ = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            _[_i] = arguments[_i];
        }
    };
}
exports.Debug = Debug;
function ShiyiDebug(level) {
    var args = [];
    for (var _i = 1; _i < arguments.length; _i++) {
        args[_i - 1] = arguments[_i];
    }
    if (level == 0) {
        return;
    }
    else if (level <= Utils_Config_1.DebugLevel) {
        Debug(3)(args);
    }
}
exports.ShiyiDebug = ShiyiDebug;
var nameof = function (name) { return name; };
exports.nameof = nameof;
var Guid = (function () {
    function Guid(value) {
        this.value = this.empty;
        if (value) {
            if (Guid.isValid(value)) {
                this.value = value;
            }
        }
    }
    Guid.newGuid = function () {
        return new Guid('xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            var r = Math.random() * 16 | 0;
            var v = (c == 'x') ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        }));
    };
    Object.defineProperty(Guid, "empty", {
        get: function () {
            return '00000000-0000-0000-0000-000000000000';
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(Guid.prototype, "empty", {
        get: function () {
            return Guid.empty;
        },
        enumerable: false,
        configurable: true
    });
    Guid.isValid = function (str) {
        var validRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
        return validRegex.test(str);
    };
    Guid.prototype.toString = function () {
        return this.value;
    };
    Guid.prototype.toJSON = function () {
        return this.value;
    };
    return Guid;
}());
exports.Guid = Guid;
function CreateRecordInstance(instance) {
    var ResRecord = {};
    var Proto = instance;
    while (Proto) {
        Object.keys(Proto).map(function (key) {
            if (!ResRecord[key]) {
                if (typeof Proto[key] === 'function') {
                    ResRecord[key] = Proto[key].bind(instance);
                }
                else {
                }
            }
        });
        Proto = Object.getPrototypeOf(Proto);
    }
    return ResRecord;
}
exports.CreateRecordInstance = CreateRecordInstance;
function ParseCookie(cookieStr) {
    var cookieStrArr = cookieStr.split('=');
    var key = cookieStrArr[0];
    var value = cookieStrArr[1].split(';')[0];
    return new KeyValuePair(key, value);
}
exports.ParseCookie = ParseCookie;
function SaveCookies(NewCookies) {
    if (NewCookies.length > 0) {
        var cookiesMap = {};
        if (wx.getStorageSync(Storage_Config_1.StorageKey.Cookies)) {
            cookiesMap = JSON.parse(wx.getStorageSync(Storage_Config_1.StorageKey.Cookies));
        }
        for (var i = 0; i < NewCookies.length; i++) {
            var cookie = ParseCookie(NewCookies[i]);
            cookiesMap[cookie.Key] = cookie.Value;
        }
        wx.setStorageSync(Storage_Config_1.StorageKey.Cookies, JSON.stringify(cookiesMap));
    }
}
exports.SaveCookies = SaveCookies;
var AsyncGroup = (function () {
    function AsyncGroup(_asyncFuncMap) {
        this.ResultMap = new Map();
        this.lock = false;
        this.AsyncFuncMap = _asyncFuncMap;
        this.CompletedCnt = this.AsyncFuncMap.size;
    }
    AsyncGroup.prototype.Run = function () {
        var _this = this;
        this.AsyncFuncMap.forEach(function (func, key) {
            func(function (result) {
                _this.ResultMap.set(key, result);
                _this.CheckComplete();
            });
        });
        return this;
    };
    AsyncGroup.prototype.ContinueWith = function (callback) {
        this.Complete = callback;
        return this;
    };
    AsyncGroup.prototype.CheckComplete = function () {
        while (this.lock) { }
        this.lock = true;
        this.CompletedCnt--;
        if (this.CompletedCnt == 0) {
            this.Complete(this.ResultMap);
        }
        this.lock = false;
    };
    return AsyncGroup;
}());
exports.AsyncGroup = AsyncGroup;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJVdGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSx5RUFBb0U7QUFDcEUsbUVBQWdFO0FBRWhFO0lBR0ksc0JBQVksSUFBUyxFQUFFLE1BQVc7UUFDOUIsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUM7UUFDaEIsSUFBSSxDQUFDLEtBQUssR0FBRyxNQUFNLENBQUM7SUFDeEIsQ0FBQztJQUNMLG1CQUFDO0FBQUQsQ0FBQyxBQVBELElBT0M7QUFQWSxvQ0FBWTtBQVl6QixTQUFnQixLQUFLLENBQUMsS0FBWTtJQUU5QixJQUFJLHlCQUFVLElBQUksQ0FBQyxFQUFFO1FBQ2pCLE9BQU87WUFBQyxXQUFRO2lCQUFSLFVBQVEsRUFBUixxQkFBUSxFQUFSLElBQVE7Z0JBQVIsc0JBQVE7O1FBQUksQ0FBQyxDQUFDO0tBQ3pCO1NBQU0sSUFBSSxLQUFLLElBQUkseUJBQVUsRUFBRTtRQUM1QixPQUFPLE9BQU8sQ0FBQyxHQUFHLENBQUM7S0FDdEI7SUFDRCxPQUFPO1FBQUMsV0FBUTthQUFSLFVBQVEsRUFBUixxQkFBUSxFQUFSLElBQVE7WUFBUixzQkFBUTs7SUFBSSxDQUFDLENBQUM7QUFDMUIsQ0FBQztBQVJELHNCQVFDO0FBc0JELFNBQWdCLFVBQVUsQ0FBQyxLQUFhO0lBQUUsY0FBWTtTQUFaLFVBQVksRUFBWixxQkFBWSxFQUFaLElBQVk7UUFBWiw2QkFBWTs7SUFDbEQsSUFBSSxLQUFLLElBQUksQ0FBQyxFQUFFO1FBQ1osT0FBTztLQUNWO1NBQU0sSUFBSSxLQUFLLElBQUkseUJBQVUsRUFBRTtRQUM1QixLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUUsSUFBSSxDQUFDLENBQUE7S0FDbEI7QUFDTCxDQUFDO0FBTkQsZ0NBTUM7QUFFTSxJQUFNLE1BQU0sR0FBRyxVQUFJLElBQWEsSUFBSyxPQUFBLElBQUksRUFBSixDQUFJLENBQUM7QUFBcEMsUUFBQSxNQUFNLFVB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QUFDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFBO1FBQ0YsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVNLGlDQUFZLEdBQW5CLFVBQW9CLFFBQTRDO1FBQzVELElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO1FBQ3pCLE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFHTyxrQ0FBYSxHQUFyQjtRQUNJLE9BQU8sSUFBSSxDQUFDLElBQUksRUFBRSxHQUFHO1FBQ3JCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNwQixJQUFJLElBQUksQ0FBQyxZQUFZLElBQUksQ0FBQyxFQUFFO1lBQ3hCLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFBO1NBQ2hDO1FBQ0QsSUFBSSxDQUFDLElBQUksR0FBRyxLQUFLLENBQUM7SUFDdEIsQ0FBQztJQUNMLGlCQUFDO0FBQUQsQ0FBQyxBQXRDRCxJQXNDQztBQXRDWSxnQ0FBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN0b3JhZ2VLZXkgfSBmcm9tIFwiLi4vQ29uZmlnL1N0b3JhZ2VDb25maWcvU3RvcmFnZS5Db25maWdcIjtcclxuaW1wb3J0IHsgRGVidWdMZXZlbCB9IGZyb20gXCIuLi9Db25maWcvVXRpbHNDb25maWcvVXRpbHMuQ29uZmlnXCI7XHJcblxyXG5leHBvcnQgY2xhc3MgS2V5VmFsdWVQYWlyPFRfSywgVF9WPntcclxuICAgIHB1YmxpYyBLZXk6IFRfSztcclxuICAgIHB1YmxpYyBWYWx1ZTogVF9WO1xyXG4gICAgY29uc3RydWN0b3IoX2tleTogVF9LLCBfdmFsdWU6IFRfVikge1xyXG4gICAgICAgIHRoaXMuS2V5ID0gX2tleTtcclxuICAgICAgICB0aGlzLlZhbHVlID0gX3ZhbHVlO1xyXG4gICAgfVxyXG59XHJcblxyXG5cclxuLy8gdmFyIGNvbnNvbGVsb2c6YW55O1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIERlYnVnKGxldmVsOm51bWJlcik6KC4uLmFyZzphbnkpPT5hbnl7XHJcbiAgICAvL0B0cy1pZ25vcmVcclxuICAgIGlmIChEZWJ1Z0xldmVsID09IDApIHtcclxuICAgICAgICByZXR1cm4gKC4uLl86YW55KT0+e307XHJcbiAgICB9IGVsc2UgaWYgKGxldmVsIDw9IERlYnVnTGV2ZWwpIHtcclxuICAgICAgICByZXR1cm4gY29uc29sZS5sb2c7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gKC4uLl86YW55KT0+e307XHJcbn1cclxuXHJcbi8vIGV4cG9ydCBmdW5jdGlvbiBFbmFibGVTaGl5aURlYnVnKCkge1xyXG4vLyAgICAgY29uc29sZWxvZyA9IGNvbnNvbGUubG9nO1xyXG4vLyAgICAgY29uc29sZS5sb2cgPSAoLi4uYXJnOmFueSk9PntcclxuICAgICAgICBcclxuLy8gICAgIH07XHJcblxyXG4vLyAgICAgLy8gY29uc29sZS5sb2cgPSAoZnVuY3Rpb24gKG9yaUxvZ0Z1bmMpIHtcclxuLy8gICAgIC8vICAgICByZXR1cm4gZnVuY3Rpb24gKCkge1xyXG4vLyAgICAgLy8gICAgICAgICAvL2lmICghQ29uZmlnLmlzUHJvZHVjdCkge1xyXG4vLyAgICAgLy8gICAgICAgICAgICAgdHJ5IHtcclxuLy8gICAgIC8vICAgICAgICAgICAgICAgICBvcmlMb2dGdW5jLmNhbGwoY29uc29sZSwgLi4uYXJndW1lbnRzKTtcclxuLy8gICAgIC8vICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuLy8gICAgIC8vICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdjb25zb2xlLmxvZyBlcnJvcicsIGUpO1xyXG4vLyAgICAgLy8gICAgICAgICAgICAgfVxyXG4vLyAgICAgLy8gICAgICAgICAvL31cclxuLy8gICAgIC8vICAgICB9XHJcbi8vICAgICAvLyB9KShjb25zb2xlLmxvZyk7XHJcbi8vICAgICAvLyBjb25zb2xlLmxvZyhcInRlc3QgY29uc29sZS5sb2dcIik7XHJcbi8vIH1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBTaGl5aURlYnVnKGxldmVsOiBudW1iZXIsIC4uLmFyZ3M6IGFueSkge1xyXG4gICAgaWYgKGxldmVsID09IDApIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9IGVsc2UgaWYgKGxldmVsIDw9IERlYnVnTGV2ZWwpIHtcclxuICAgICAgICBEZWJ1ZygzKSggYXJncylcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IG5hbWVvZiA9IDxUPihuYW1lOiBrZXlvZiBUKSA9PiBuYW1lO1xyXG5cclxuZXhwb3J0IGNsYXNzIEd1aWQge1xyXG4gICAgcHVibGljIHN0YXRpYyBuZXdHdWlkKCk6IEd1aWQge1xyXG4gICAgICAgIHJldHVybiBuZXcgR3VpZCgneHh4eHh4eHgteHh4eC00eHh4LXl4eHgteHh4eHh4eHh4eHh4Jy5yZXBsYWNlKC9beHldL2csIGMgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCByID0gTWF0aC5yYW5kb20oKSAqIDE2IHwgMDtcclxuICAgICAgICAgICAgY29uc3QgdiA9IChjID09ICd4JykgPyByIDogKHIgJiAweDMgfCAweDgpO1xyXG4gICAgICAgICAgICByZXR1cm4gdi50b1N0cmluZygxNik7XHJcbiAgICAgICAgfSkpO1xyXG4gICAgfVxyXG4gICAgcHVibGljIHN0YXRpYyBnZXQgZW1wdHkoKTogc3RyaW5nIHtcclxuICAgICAgICByZXR1cm4gJzAwMDAwMDAwLTAwMDAtMDAwMC0wMDAwLTAwMDAwMDAwMDAwMCc7XHJcbiAgICB9XHJcbiAgICBwdWJsaWMgZ2V0IGVtcHR5KCk6IHN0cmluZyB7XHJcbiAgICAgICAgcmV0dXJuIEd1aWQuZW1wdHk7XHJcbiAgICB9XHJcbiAgICBwdWJsaWMgc3RhdGljIGlzVmFsaWQoc3RyOiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgICAgICBjb25zdCB2YWxpZFJlZ2V4ID0gL15bMC05YS1mXXs4fS1bMC05YS1mXXs0fS1bMS01XVswLTlhLWZdezN9LVs4OWFiXVswLTlhLWZdezN9LVswLTlhLWZdezEyfSQvaTtcclxuICAgICAgICByZXR1cm4gdmFsaWRSZWdleC50ZXN0KHN0cik7XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIHZhbHVlOiBzdHJpbmcgPSB0aGlzLmVtcHR5O1xyXG4gICAgY29uc3RydWN0b3IodmFsdWU/OiBzdHJpbmcpIHtcclxuICAgICAgICBpZiAodmFsdWUpIHtcclxuICAgICAgICAgICAgaWYgKEd1aWQuaXNWYWxpZCh2YWx1ZSkpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHB1YmxpYyB0b1N0cmluZygpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy52YWx1ZTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgdG9KU09OKCk6IHN0cmluZyB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMudmFsdWU7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBDcmVhdGVSZWNvcmRJbnN0YW5jZShpbnN0YW5jZTogYW55KSB7XHJcbiAgICBsZXQgUmVzUmVjb3JkOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge31cclxuICAgIHR5cGUgS19UID0ga2V5b2YgdHlwZW9mIGluc3RhbmNlO1xyXG4gICAgbGV0IFByb3RvID0gaW5zdGFuY2U7XHJcbiAgICB3aGlsZSAoUHJvdG8pIHtcclxuICAgICAgICBPYmplY3Qua2V5cyhQcm90bykubWFwKGtleSA9PiB7XHJcbiAgICAgICAgICAgIGlmICghUmVzUmVjb3JkW2tleV0pIHtcclxuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgUHJvdG9ba2V5IGFzIEtfVF0gPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgICAgICAgICAgICAvL0B0cy1pZ25vcmVcclxuICAgICAgICAgICAgICAgICAgICBSZXNSZWNvcmRba2V5XSA9IChQcm90b1trZXkgYXMgS19UXSBhcyBGdW5jdGlvbikuYmluZChpbnN0YW5jZSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vUmVzUmVjb3JkW2tleV0gPSBQcm90b1trZXkgYXMgS19UXVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICAgICAgICBQcm90byA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihQcm90byk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gUmVzUmVjb3JkO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gUGFyc2VDb29raWUoY29va2llU3RyOiBzdHJpbmcpOiBLZXlWYWx1ZVBhaXI8c3RyaW5nLCBzdHJpbmc+IHtcclxuICAgIGxldCBjb29raWVTdHJBcnI6IHN0cmluZ1tdID0gY29va2llU3RyLnNwbGl0KCc9Jyk7XHJcbiAgICBsZXQga2V5OiBzdHJpbmcgPSBjb29raWVTdHJBcnJbMF07XHJcbiAgICBsZXQgdmFsdWU6IHN0cmluZyA9IGNvb2tpZVN0ckFyclsxXS5zcGxpdCgnOycpWzBdO1xyXG4gICAgcmV0dXJuIG5ldyBLZXlWYWx1ZVBhaXI8c3RyaW5nLCBzdHJpbmc+KGtleSwgdmFsdWUpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gU2F2ZUNvb2tpZXMoTmV3Q29va2llczogc3RyaW5nW10pIHtcclxuICAgIGlmIChOZXdDb29raWVzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICBsZXQgY29va2llc01hcDogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHt9O1xyXG4gICAgICAgIGlmICh3eC5nZXRTdG9yYWdlU3luYyhTdG9yYWdlS2V5LkNvb2tpZXMpKSB7XHJcbiAgICAgICAgICAgIGNvb2tpZXNNYXAgPSBKU09OLnBhcnNlKHd4LmdldFN0b3JhZ2VTeW5jKFN0b3JhZ2VLZXkuQ29va2llcykpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IE5ld0Nvb2tpZXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgbGV0IGNvb2tpZTogS2V5VmFsdWVQYWlyPHN0cmluZywgc3RyaW5nPiA9IFBhcnNlQ29va2llKE5ld0Nvb2tpZXNbaV0pO1xyXG4gICAgICAgICAgICBjb29raWVzTWFwW2Nvb2tpZS5LZXldID0gY29va2llLlZhbHVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICB3eC5zZXRTdG9yYWdlU3luYyhTdG9yYWdlS2V5LkNvb2tpZXMsIEpTT04uc3RyaW5naWZ5KGNvb2tpZXNNYXApKTtcclxuICAgIH1cclxufVxyXG5cclxuXHJcbmV4cG9ydCBjbGFzcyBBc3luY0dyb3VwIHtcclxuICAgIHByaXZhdGUgQXN5bmNGdW5jTWFwOiBNYXA8c3RyaW5nLCAoY2FsbGJhY2s6IChyZXN1bHQ6IGFueSkgPT4gdm9pZCkgPT4gYW55PlxyXG4gICAgcHJpdmF0ZSBSZXN1bHRNYXA6IE1hcDxzdHJpbmcsIGFueT4gPSBuZXcgTWFwPHN0cmluZywgYW55PigpO1xyXG4gICAgcHJpdmF0ZSBDb21wbGV0ZWRDbnQ6IG51bWJlcjtcclxuXHJcbiAgICAvL0B0cy1pZ25vcmVcclxuICAgIHByaXZhdGUgQ29tcGxldGU6IChyZXN1bHQ6IE1hcDxzdHJpbmcsIGFueT4pID0+IHZvaWQ7XHJcblxyXG4gICAgY29uc3RydWN0b3IoX2FzeW5jRnVuY01hcDogTWFwPHN0cmluZywgKGNhbGxiYWNrOiAocmVzdWx0OiBhbnkpID0+IHZvaWQpID0+IGFueT4pIHtcclxuICAgICAgICB0aGlzLkFzeW5jRnVuY01hcCA9IF9hc3luY0Z1bmNNYXA7XHJcbiAgICAgICAgdGhpcy5Db21wbGV0ZWRDbnQgPSB0aGlzLkFzeW5jRnVuY01hcC5zaXplO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBSdW4oKTogQXN5bmNHcm91cCB7XHJcbiAgICAgICAgdGhpcy5Bc3luY0Z1bmNNYXAuZm9yRWFjaCgoZnVuYywga2V5KSA9PiB7XHJcbiAgICAgICAgICAgIGZ1bmMoKHJlc3VsdCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5SZXN1bHRNYXAuc2V0KGtleSwgcmVzdWx0KTtcclxuICAgICAgICAgICAgICAgIHRoaXMuQ2hlY2tDb21wbGV0ZSgpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KVxyXG4gICAgICAgIHJldHVybiB0aGlzO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBDb250aW51ZVdpdGgoY2FsbGJhY2s6IChyZXN1bHQ6IE1hcDxzdHJpbmcsIGFueT4pID0+IHZvaWQpOiBBc3luY0dyb3VwIHtcclxuICAgICAgICB0aGlzLkNvbXBsZXRlID0gY2FsbGJhY2s7XHJcbiAgICAgICAgcmV0dXJuIHRoaXM7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBsb2NrOiBib29sZWFuID0gZmFsc2U7XHJcbiAgICBwcml2YXRlIENoZWNrQ29tcGxldGUoKSB7XHJcbiAgICAgICAgd2hpbGUgKHRoaXMubG9jaykgeyB9XHJcbiAgICAgICAgdGhpcy5sb2NrID0gdHJ1ZTtcclxuICAgICAgICB0aGlzLkNvbXBsZXRlZENudC0tO1xyXG4gICAgICAgIGlmICh0aGlzLkNvbXBsZXRlZENudCA9PSAwKSB7XHJcbiAgICAgICAgICAgIHRoaXMuQ29tcGxldGUodGhpcy5SZXN1bHRNYXApXHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMubG9jayA9IGZhbHNlO1xyXG4gICAgfVxyXG59Il19